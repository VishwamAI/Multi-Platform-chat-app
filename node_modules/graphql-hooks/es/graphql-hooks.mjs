import e,{useRef as t,useContext as r,useEffect as o}from"react";import s from"events";const n=e.createContext(null);n.displayName="ClientContext";var i=function(e){return"undefined"!=typeof File&&e instanceof File||"undefined"!=typeof Blob&&e instanceof Blob||e instanceof class{constructor({uri:e,name:t,type:r}){this.uri=e,this.name=t,this.type=r}}};const a=e=>i(e)||null!==e&&"object"==typeof e&&"function"==typeof e.pipe||null!==e&&"object"==typeof e&&"function"==typeof e.stream;class c{constructor(e){0===e.length&&e.push(((e,t)=>t()));for(const t of e){if("function"!=typeof t)throw Error("GraphQLClient Middleware: middleware has to be of type `function`");this.run=(e=>(r,o)=>{e(r,(()=>{t.call(this,r,o.bind.call(o,null,r))}))})(this.run)}}run(e,t){t.apply(this,e)}}var u=Object.defineProperty,l=Object.getOwnPropertySymbols,h=Object.prototype.hasOwnProperty,f=Object.prototype.propertyIsEnumerable,p=(e,t,r)=>t in e?u(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,d=(e,t)=>{for(var r in t||(t={}))h.call(t,r)&&p(e,r,t[r]);if(l)for(var r of l(t))f.call(t,r)&&p(e,r,t[r]);return e};class b{constructor(e){if(!e)throw Error("GraphQLClient: config is required as first parameter");this.fullWsTransport=e.fullWsTransport,this.subscriptionClient="function"==typeof e.subscriptionClient?e.subscriptionClient():e.subscriptionClient,this.verifyConfig(e),this.cache=e.cache,this.headers=e.headers||{},this.ssrMode=e.ssrMode,this.ssrPromises=[],this.url=e.url,this.fetch=e.fetch||("undefined"!=typeof fetch&&fetch?fetch.bind(void 0):void 0),this.fetchOptions=e.fetchOptions||{},this.FormData=e.FormData||("undefined"!=typeof FormData?FormData:void 0),this.logErrors=void 0===e.logErrors||e.logErrors,this.onError=e.onError,this.useGETForQueries=!0===e.useGETForQueries,this.middleware=new c(e.middleware||[]),this.mutationsEmitter=new s}verifyConfig(e){if(!e.url){if(!this.fullWsTransport)throw Error("GraphQLClient: config.url is required");if(!this.subscriptionClient)throw Error("GraphQLClient: subscriptionClient is required")}if(e.fetch&&"function"!=typeof e.fetch)throw Error("GraphQLClient: config.fetch must be a function");if(("undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement||e.ssrMode)&&!e.fetch&&"function"!=typeof fetch)throw Error("GraphQLClient: fetch must be polyfilled or passed in new GraphQLClient({ fetch })");if(e.ssrMode&&!e.cache)throw Error("GraphQLClient: config.cache is required when in ssrMode")}setHeader(e,t){return this.headers[e]=t,this}setHeaders(e){return this.headers=e,this}removeHeader(e){return delete this.headers[e],this}logErrorResult({result:e,operation:t}){console.error("GraphQL Hooks Error"),console.groupCollapsed("---\x3e Full Error Details"),console.groupCollapsed("Operation:"),console.log(t),console.groupEnd();const r=e.error;r&&(r.fetchError&&(console.groupCollapsed("FETCH ERROR:"),console.log(r.fetchError),console.groupEnd()),r.httpError&&(console.groupCollapsed("HTTP ERROR:"),console.log(r.httpError),console.groupEnd()),r.graphQLErrors&&r.graphQLErrors.length>0&&(console.groupCollapsed("GRAPHQL ERROR:"),r.graphQLErrors.forEach((e=>console.log(e))),console.groupEnd())),console.groupEnd()}generateResult({fetchError:e,httpError:t,graphQLErrors:r,data:o}){return!!(r&&r.length>0||e||t)?{data:o,error:{fetchError:e,httpError:t,graphQLErrors:r}}:{data:o}}getCacheKey(e,t={}){return{operation:e,fetchOptions:d(d({},this.fetchOptions),t.fetchOptionsOverrides)}}getCache(e){const t=this.cache?this.cache.get(e):null;if(t)return t}saveCache(e,t){this.cache&&this.cache.set(e,t)}getFetchOptions(e,t={}){const r=d(d({method:"POST",headers:d({},this.headers)},this.fetchOptions),t);if("GET"===r.method)return r;const{clone:o,files:s}=function(e,t="",r=i){const o=new Map,s=new Map;return{clone:function e(t,n,i){let a=t;if(r(t)){a=null;const e=o.get(t);e?e.push(n):o.set(t,[n])}else{const r=Array.isArray(t)||"undefined"!=typeof FileList&&t instanceof FileList,o=t&&t.constructor===Object;if(r||o){const o=s.has(t);if(o?a=s.get(t):(a=r?[]:{},s.set(t,a)),!i.has(t)){const s=n?n+".":"",c=new Set(i).add(t);if(r){let r=0;for(const n of t){const t=e(n,s+r++,c);o||a.push(t)}}else for(const r in t){const n=e(t[r],s+r,c);o||(a[r]=n)}}}}return a}(e,t,new Set),files:o}}(e,"",a),n=JSON.stringify(o);if(s.size){if(!this.FormData)throw Error("GraphQLClient: FormData must be polyfilled or passed in new GraphQLClient({ FormData })");const e=new this.FormData;e.append("operations",n);const t={};let o=0;s.forEach((e=>{t[++o]=e})),e.append("map",JSON.stringify(t)),o=0,s.forEach(((t,r)=>{e.append(""+ ++o,r,r.name)})),r.body=e}else r.headers["Content-Type"]="application/json",r.body=n;return r}request(e,t){const r=[],o=e=>r.push(e);return new Promise(((s,n)=>this.middleware.run({operation:e,client:this,addResponseHook:o,resolve:s,reject:n},(({operation:e})=>{const o=e=>{return r.length>0?(t=r,e=>t.reduce(((e,t)=>e.then(t)),Promise.resolve(e)))(e):e;var t};return this.fullWsTransport?this.requestViaWS(e).then(o).then(s).catch(n):this.url?this.requestViaHttp(e,t).then(o).then(s).catch(n):void n(Error("GraphQLClient: config.url is required"))}))))}requestViaHttp(e,t={}){let r=this.url;const o=this.getFetchOptions(e,t.fetchOptionsOverrides);if("GET"===o.method){r=r+"?"+Object.entries(e).filter((([,e])=>!!e)).map((([e,t])=>("variables"!==e&&"extensions"!==e||(t=JSON.stringify(t)),`${e}=${encodeURIComponent(t)}`))).join("&")}return this.fetch(r,o).then((e=>e.ok?e.json().then((({errors:r,data:o})=>this.generateResult({graphQLErrors:r,data:"function"==typeof t.responseReducer&&t.responseReducer(o,e)||o}))):e.text().then((t=>{const{status:r,statusText:o}=e;return this.generateResult({httpError:{status:r,statusText:o,body:t}})})))).catch((e=>this.generateResult({fetchError:e}))).then((t=>(t.error&&(this.logErrors&&this.logErrorResult({result:t,operation:e}),this.onError&&this.onError({result:t,operation:e})),t)))}requestViaWS(e){return new Promise(((t,r)=>{let o;try{const s=this.createSubscription(e).subscribe({next:e=>{o=e},error:r,complete:()=>{s.unsubscribe(),t(o)}})}catch(e){r(e)}}))}createSubscription(e){if(!this.subscriptionClient)throw Error("No SubscriptionClient! Please set in the constructor.");return"function"==typeof this.subscriptionClient.subscribe?{subscribe:t=>({unsubscribe:this.subscriptionClient.subscribe(e,t)})}:this.subscriptionClient.request(e)}}class y{constructor(e){this.fetchError=e.fetchError,this.httpError=e.httpError,this.graphQLErrors=e.graphQLErrors}}var E=Object.defineProperty,g=Object.getOwnPropertySymbols,m=Object.prototype.hasOwnProperty,O=Object.prototype.propertyIsEnumerable,w=(e,t,r)=>t in e?E(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;class v extends b{constructor(e){if(super(((e,t)=>{for(var r in t||(t={}))m.call(t,r)&&w(e,r,t[r]);if(g)for(var r of g(t))O.call(t,r)&&w(e,r,t[r]);return e})({url:""},e)),this.localQueries=e.localQueries,this.requestDelayMs=e.requestDelayMs||0,!this.localQueries)throw Error("LocalGraphQLClient: `localQueries` object required in the constructor options")}verifyConfig(){}request(e){if(!this.localQueries[e.query])throw Error("LocalGraphQLClient: no query match for: "+e.query);return(t=this.requestDelayMs,new Promise((e=>{setTimeout(e,t)}))).then((()=>Promise.resolve(this.localQueries[e.query](e.variables,e.operationName)))).then((e=>e instanceof y?{error:e}:{data:e}));var t}}var C=Object.prototype.hasOwnProperty;function j(e,t,r){for(r of e.keys())if(L(r,t))return r}function L(e,t){var r,o,s;if(e===t)return!0;if(e&&t&&(r=e.constructor)===t.constructor){if(r===Date)return e.getTime()===t.getTime();if(r===RegExp)return""+e==""+t;if(r===Array){if((o=e.length)===t.length)for(;o--&&L(e[o],t[o]););return-1===o}if(r===Set){if(e.size!==t.size)return!1;for(o of e){if((s=o)&&"object"==typeof s&&!(s=j(t,s)))return!1;if(!t.has(s))return!1}return!0}if(r===Map){if(e.size!==t.size)return!1;for(o of e){if((s=o[0])&&"object"==typeof s&&!(s=j(t,s)))return!1;if(!L(o[1],t.get(s)))return!1}return!0}if(r===ArrayBuffer)e=new Uint8Array(e),t=new Uint8Array(t);else if(r===DataView){if((o=e.byteLength)===t.byteLength)for(;o--&&e.getInt8(o)===t.getInt8(o););return-1===o}if(ArrayBuffer.isView(e)){if((o=e.byteLength)===t.byteLength)for(;o--&&e[o]===t[o];);return-1===o}if(!r||"object"==typeof e){for(r in o=0,e){if(C.call(e,r)&&++o&&!C.call(t,r))return!1;if(!(r in t)||!L(e[r],t[r]))return!1}return Object.keys(t).length===o}}return e!=e&&t!=t}var Q=Object.defineProperty,S=Object.defineProperties,P=Object.getOwnPropertyDescriptors,q=Object.getOwnPropertySymbols,D=Object.prototype.hasOwnProperty,R=Object.prototype.propertyIsEnumerable,T=(e,t,r)=>t in e?Q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,M=(e,t)=>{for(var r in t||(t={}))D.call(t,r)&&T(e,r,t[r]);if(q)for(var r of q(t))R.call(t,r)&&T(e,r,t[r]);return e},G=(e,t)=>S(e,P(t));const F="RESET_STATE",k="LOADING",H="CACHE_HIT",x="REQUEST_RESULT";function A(e,t){switch(t.type){case F:return t.initialState;case k:return e.error?G(M({},t.initialState),{data:e.data,loading:!0}):e.loading?e:G(M({},e),{loading:!0});case H:return e.cacheHit&&!t.resetState?e:G(M({},t.result),{cacheHit:!0,loading:!1});case x:return G(M({},t.result),{data:e.data&&t.result.data&&t.updateData?t.updateData(e.data,t.result.data):t.result.data,cacheHit:!1,loading:!1});default:return e}}function N(t,r={}){if("string"!=typeof t)throw Error("Your query must be a string. If you are using the `gql` template literal from graphql-tag, remove it from your query.");const o=e.useContext(n),s=r.client||o;if(null==s)throw Error("A client must be provided in order to use the useClientRequest hook.");const i=e.useRef(!0),a=e.useRef(null),c={query:t,variables:r.variables,operationName:r.operationName,persisted:r.persisted};(r.persisted||s.useGETForQueries&&!r.isMutation)&&(r.fetchOptionsOverrides=G(M({},r.fetchOptionsOverrides),{method:"GET"}));const u=s.getCacheKey(c,r),l=r.isMutation||r.isManual||r.skip,h=!r.skipCache&&s.cache&&u?s.cache.get(u):null,f=G(M({},h),{cacheHit:!!h,loading:!l&&!h}),[p,d]=e.useReducer(A,f),b=JSON.stringify(u);e.useEffect((()=>{r.updateData||d({type:F,initialState:f})}),[b]),e.useEffect((()=>(i.current=!0,()=>{i.current=!1})),[]);const y=function(t,r){const o=e.useRef();return L(r,o.current)||(o.current=r),e.useCallback(t,o.current)}((e=>{const o=M(M({},r),e),n=G(M({},c),{variables:o.variables,operationName:o.operationName});if(!i.current)return Promise.resolve({error:{fetchError:Error("fetchData should not be called after hook unmounted")},loading:!1,cacheHit:!1});const u=s.getCacheKey(n,o);a.current=u;const l=o.skipCache?null:s.getCache(u);return l?(d({type:H,result:l,resetState:b!==JSON.stringify(p.cacheKey)}),Promise.resolve(l)):(d({type:k,initialState:f}),s.request(n,o).then((e=>{if(o.updateData&&"function"!=typeof o.updateData)throw Error("options.updateData must be a function");const c=M({},e);if(o.useCache&&(c.useCache=!0,c.cacheKey=u,s.ssrMode)){const e={error:c.error,data:o.updateData?o.updateData(p.data,c.data):c.data};s.saveCache(u,e)}return i.current&&u===a.current&&d({type:x,updateData:o.updateData,result:c}),r.isMutation&&s.mutationsEmitter.emit(t,G(M({},n),{mutation:t,result:c})),e})))}),[s,r,c]);e.useEffect((()=>{p.useCache&&!s.ssrMode&&s.saveCache(p.cacheKey,p)}),[s,p]);return[y,p,(e={})=>d({type:F,initialState:M(M({},f),e)})]}var I=Object.defineProperty,J=Object.defineProperties,K=Object.getOwnPropertyDescriptors,V=Object.getOwnPropertySymbols,W=Object.prototype.hasOwnProperty,z=Object.prototype.propertyIsEnumerable,U=(e,t,r)=>t in e?I(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,B=(e,t)=>{for(var r in t||(t={}))W.call(t,r)&&U(e,r,t[r]);if(V)for(var r of V(t))z.call(t,r)&&U(e,r,t[r]);return e};const _={useCache:!0,skip:!1,throwErrors:!1};function $(t,r={}){const o=B(B({},_),r),s=e.useContext(n),i=r.client||s,[a,c]=e.useState(!1),[u,l]=N(t,o);if(!i)throw Error("useQuery() requires a client to be passed in the options or as a context value");if(i.ssrMode&&!1!==r.ssr&&!a&&!r.skipCache&&!r.skip){if(!l.data&&!l.error){const e=u();i.ssrPromises.push(e)}c(!0)}const h=JSON.stringify(o);e.useEffect((()=>{o.skip||u()}),[t,h]),e.useEffect((()=>{if(l.error&&o.throwErrors)throw l.error}),[l.error,o.throwErrors]);const f=e.useCallback(((e={})=>u(B({skipCache:!0,updateData:(e,t)=>t},e))),[u]);return e.useEffect((function(){const e=function(e){const t={};return(Array.isArray(e)?e:[e]).forEach((e=>{if(null==e)return;const r=typeof e;if("string"===r)t[e]={};else if("object"===r){const{filter:r,mutation:o}=e;t[o]={filter:r}}})),t}(r.refetchAfterMutations),t=Object.keys(e),o=({mutation:t,variables:r})=>{const{filter:o}=e[t];(!o||r&&o(r))&&f()};return t.forEach((e=>{i.mutationsEmitter.on(e,o)})),()=>{t.forEach((e=>{i.mutationsEmitter.removeListener(e,o)}))}}),[r.refetchAfterMutations,f,i.mutationsEmitter]),p=B({},l),J(p,K({refetch:f}));var p}function Y(e,s){const i=t(s);i.current=s;const a=r(n),c=e.client||a;if(!c)throw Error("useSubscription() requires a client to be passed in the options or as a context value");const u={query:e.query,variables:e.variables};o((()=>{const e=c.createSubscription(u).subscribe({next:e=>{i.current(e)},error:e=>{i.current({errors:e})},complete:()=>{e.unsubscribe()}});return()=>{e.unsubscribe()}}),[])}var X=Object.defineProperty,Z=Object.getOwnPropertySymbols,ee=Object.prototype.hasOwnProperty,te=Object.prototype.propertyIsEnumerable,re=(e,t,r)=>t in e?X(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,oe=(e,t)=>{for(var r in t||(t={}))ee.call(t,r)&&re(e,r,t[r]);if(Z)for(var r of Z(t))te.call(t,r)&&re(e,r,t[r]);return e};const se=(e,t={})=>N(e,oe({useCache:!0,isManual:!0},t)),ne=(e,t={})=>N(e,oe({isMutation:!0},t));export{n as ClientContext,b as GraphQLClient,v as LocalGraphQLClient,y as LocalGraphQLError,N as useClientRequest,se as useManualQuery,ne as useMutation,$ as useQuery,Y as useSubscription};
